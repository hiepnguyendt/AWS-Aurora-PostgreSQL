<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.123.1">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Benchmarking with Cluster Cache management :: AWS RDS PostgreSQL</title>

    
    <link href="/css/nucleus.css?1711431242" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1711431242" rel="stylesheet">
    <link href="/css/hybrid.css?1711431242" rel="stylesheet">
    <link href="/css/featherlight.min.css?1711431242" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1711431242" rel="stylesheet">
    <link href="/css/auto-complete.css?1711431242" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1711431242" rel="stylesheet">
    <link href="/css/theme.css?1711431242" rel="stylesheet">
    <link href="/css/hugo-theme.css?1711431242" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1711431242" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1711431242"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/5-clustercachemanagement/5-2-benchmarkingwithclustercachemanagement/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1711431242"></script>
<script type="text/javascript" src="/js/auto-complete.js?1711431242"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1711431242"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-introduce/" title="Introduction" class="dd-item 
        
        
        
        ">
      <a href="/1-introduce/">
           <b> 1. </b> Introduction
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-preparation/" title="Preparation Steps" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/">
           <b> 2. </b> Preparation Steps
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-1-createvpc/" title="Create a VPC" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-1-createvpc/">
           <b> 2.1. </b> Create a VPC
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-2-createsg/" title="Create Security Group " class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-2-createsg/">
           <b> 2.2. </b> Create Security Group 
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-3-createec2/" title="Create a EC2 instance" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-3-createec2/">
           <b> 2.3. </b> Create a EC2 instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-4-createpgsg/" title="Create Subnet Group and Parameter Group" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-4-createpgsg/">
           <b> 2.4. </b> Create Subnet Group and Parameter Group
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-5-createaupg/" title="Create Aurora PostgreSQL Database" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-5-createaupg/">
           <b> 2.5. </b> Create Aurora PostgreSQL Database
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-preparation/2-6-configurecloud9andinitializedatabase/" title=" Create, Configure Cloud9 and Initialize Database" class="dd-item 
        
        
        
        ">
      <a href="/2-preparation/2-6-configurecloud9andinitializedatabase/">
           <b> 2.6.</b>  Create, Configure Cloud9 and Initialize Database
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-fastcloning/" title="Fast Cloning" class="dd-item 
        
        
        
        ">
      <a href="/3-fastcloning/">
           <b> 3. </b> Fast Cloning
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-queryplanmanagement/" title="Query Plan Management" class="dd-item 
        
        
        
        ">
      <a href="/4-queryplanmanagement/">
           <b> 4. </b> Query Plan Management
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-clustercachemanagement/" title="Cluster Cache Management" class="dd-item 
        parent
        
        
        ">
      <a href="/5-clustercachemanagement/">
           <b> 5. </b> Cluster Cache Management
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/5-clustercachemanagement/5-1-setupclustercachemanagement/" title="Setup cluster cache management" class="dd-item 
        
        
        
        ">
      <a href="/5-clustercachemanagement/5-1-setupclustercachemanagement/">
           <b> 5.1. </b> Setup cluster cache management
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5-clustercachemanagement/5-2-benchmarkingwithclustercachemanagement/" title="Benchmarking with Cluster Cache management" class="dd-item 
        
        active
        
        ">
      <a href="/5-clustercachemanagement/5-2-benchmarkingwithclustercachemanagement/">
           <b> 5.2. </b> Benchmarking with Cluster Cache management
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-databaseactivitystreaming/" title="Database activity streaming" class="dd-item 
        
        
        
        ">
      <a href="/6-databaseactivitystreaming/">
           <b> 6. </b> Database activity streaming
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/6-databaseactivitystreaming/6-1-setupkmsfordatabaseactivitystreamsinaction/" title="Setup KMS for Database Activity Streaming" class="dd-item 
        
        
        
        ">
      <a href="/6-databaseactivitystreaming/6-1-setupkmsfordatabaseactivitystreamsinaction/">
           <b> 6.1. </b> Setup KMS for Database Activity Streaming
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/6-databaseactivitystreaming/6-2-dbactivitystreamsinaction/" title="Database Activity Streams in action" class="dd-item 
        
        
        
        ">
      <a href="/6-databaseactivitystreaming/6-2-dbactivitystreamsinaction/">
           <b> 6.2. </b> Database Activity Streams in action
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/7-rdsperformanceinsights/" title="RDS Performance Insights" class="dd-item 
        
        
        
        ">
      <a href="/7-rdsperformanceinsights/">
           <b> 7. </b> RDS Performance Insights
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/8-createdatasetandautoscale/" title="Create dataset and Auto Scale" class="dd-item 
        
        
        
        ">
      <a href="/8-createdatasetandautoscale/">
           <b> 8. </b> Create dataset and Auto Scale
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/9-testfaulttolerance/" title="Test Fault Tolerance" class="dd-item 
        
        
        
        ">
      <a href="/9-testfaulttolerance/">
           <b> 9. </b> Test Fault Tolerance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/9-testfaulttolerance/9-1-setupfailovereventnotifications/" title="Set up failover event notifications" class="dd-item 
        
        
        
        ">
      <a href="/9-testfaulttolerance/9-1-setupfailovereventnotifications/">
           <b> 9.1. </b> Set up failover event notifications
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/9-testfaulttolerance/9-2-testamanualdbclusterfailover/" title="Test a manual DB cluster failover" class="dd-item 
        
        
        
        ">
      <a href="/9-testfaulttolerance/9-2-testamanualdbclusterfailover/">
           <b> 9.2. </b> Test a manual DB cluster failover
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/9-testfaulttolerance/9-3-testingfaultinjectionqueries/" title="Testing fault injection queries" class="dd-item 
        
        
        
        ">
      <a href="/9-testfaulttolerance/9-3-testingfaultinjectionqueries/">
           <b> 9.3 </b> Testing fault injection queries
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-comparationrdspgandaupg/" title="Comparison RDS PostgreSQL and Aurora PostgreSQL" class="dd-item 
        
        
        
        ">
      <a href="/10-comparationrdspgandaupg/">
           <b> 10. </b> Comparison RDS PostgreSQL and Aurora PostgreSQL
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/11-cleanup/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="/11-cleanup/">
           <b> 11. </b> Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/5-clustercachemanagement/5-2-benchmarkingwithclustercachemanagement/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/5-clustercachemanagement/5-2-benchmarkingwithclustercachemanagement/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-01-2022</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/sutrinh/"  style="color:orange">Sử Trịnh  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
                <a href="https://www.linkedin.com/in/hiepnguyendt"  style="color:orange">Thanh Hiệp </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>AWS Aurora PostgreSQL</a> > <a href='/5-clustercachemanagement/'>Cluster Cache Management</a> > Benchmarking with Cluster Cache management
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
        <li><a href="#benchmarking-with-ccm-enabled">Benchmarking with CCM enabled</a></li>
        <li><a href="#benchmarking-with-ccm-disabled">Benchmarking with CCM disabled</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Benchmarking with Cluster Cache management
            </h1>
          

        



	<h4 id="benchmarking-with-cluster-cache-management">Benchmarking with Cluster Cache management</h4>
<p>To verify the benefits of Cluster cache management feature on the Aurora cluster we will be performing the following steps. We will explore these steps in more detail in corresponding sections below.</p>
<ul>
<li>With CCM enabled, we will run pgbench benchmark on the writer node.</li>
<li>We&rsquo;ll check cached pages on both writer and reader nodes to verify that they are kept in sync.</li>
<li>Then we&rsquo;ll Failover Aurora cluster.</li>
<li>We&rsquo;ll run pgbench benchmark on new writer node after the failover and verify that the TPS numbers between old and new writer nodes are similar.</li>
<li>Then we&rsquo;ll disable CCM.</li>
<li>We&rsquo;ll clear buffer cache of both writer and reader nodes by stopping and starting the cluster.</li>
<li>With CCM disabled, we&rsquo;ll run benchmark on writer node using pgbench again.</li>
<li>We&rsquo;ll check cached pages on both writer and reader nodes to verify that they are not kept in sync.</li>
<li>Next, we&rsquo;ll failover Aurora cluster one more time.</li>
<li>We&rsquo;ll run pgbench benchmark on the new writer node after failover and verify that the TPS numbers between old and new writer nodes vary significantly.</li>
</ul>
<ol>
<li>Load large dataset for benchmarking

<div class="notices note" ><p>In order to reproduce the benchmarking used in the lab, we need to add more sample data to our benchmark. The below command is using scale factor of 10000. This optional step could take ~15-20 mins to add more data to the database, so make sure you have enough time to complete the lab before running the script below.</p>
</div>
</li>
</ol>
<ul>
<li>
<p>Run the following command in your Cloud9 terminal window to connect to the writer node of the Aurora cluster using pgbench and add sample data with scale factor = 10000</p>
<pre tabindex="0"><code>pgbench -i --fillfactor=100 --scale=10000
</code></pre></li>
<li>
<p>Check aupglab database size using PSQL.</p>
<pre tabindex="0"><code>psql
SELECT pg_size_pretty( pg_database_size(&#39;aupglab&#39;));
</code></pre></li>
</ul>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	If you have used scale factor 100) in pgbench, you will see ourput similar to the following:
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <p><img alt="benchmark" src="/images/5/5.2/1.png"></p>

    </div>
</div>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	If you ran pgbench with the scale factor 10000 in the previous step, you will see output similar to the following:
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <p><img alt="benchmark" src="/images/5/5.2/2.png"></p>

    </div>
</div>
<h3 id="benchmarking-with-ccm-enabled">Benchmarking with CCM enabled</h3>
<ol>
<li>Run benchmark on writer node using pgbench (before failover)</li>
</ol>
<ul>
<li>
<p>Initiate a 600 seconds pgbench benchmarking on the Aurora PostgreSQL writer node with CCM enabled using the below command on your Cloud9 terminal window.</p>
<pre tabindex="0"><code>pgbench --progress-timestamp -M prepared -n -T 600 -P 5 -c 50 -j 50 -b tpcb-like@1 -b select-only@20 &gt; ccm_enable_before_failover.out 
</code></pre></li>
</ul>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	Explain command
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <p><strong>pgbench</strong>: This is a benchmarking tool for PostgreSQL databases.<br>
<strong>&ndash;progress-timestamp</strong>: Prints a timestamp with each progress report.<br>
<strong>-M prepared</strong>: Uses prepared transactions for benchmarking.<br>
<strong>-n</strong>: Specifies a no-vacuum test, which avoids vacuuming during the benchmark.<br>
<strong>-T 600</strong>: Runs the benchmark for 600 seconds (10 minutes).<br>
<strong>-P 5</strong>: Populates the database with 5 client sessions before starting the benchmark.<br>
<strong>-c 50</strong>: Runs the benchmark with 50 concurrent client connections.<br>
<strong>-j 50</strong>: Specifies 50 threads for multi-threaded operation.<br>
<strong>-b tpcb-like@1</strong>: Uses the TPC-B-like transaction mix with a weight of 1.<br>
<strong>-b select-only@20</strong>: Uses a select-only transaction mix with a weight of 20.<br>
<strong>ccm_enable_before_failover.out</strong>: Redirects the output to a file named &ldquo;ccm_enable_before_failover.out&rdquo;.</p>

    </div>
</div>

<div class="notices info" ><p>We are using pgbench  benchmarking option tpcb-like and using “@” to specify the probability of running read-only workload and read-write workload. In the below example, we are running tpcb-like workload with 20X read-only workload and 1x read-write workload for 600 seconds.</p>
</div>

<ul>
<li>
<p>After 600 seconds when benchmark is complete, you can verify the pgbench output on the screen or refer the output file “ccm_enable_before_failover.out”. The summary output will look like below. Please note that your output may look a little different.</p>
<pre tabindex="0"><code>cat ccm_enable_before_failover.out
</code></pre><p><img alt="benchmark" src="/images/5/5.2/3.png"></p>
</li>
</ul>
<h4 id="check-cached-pages-on-both-writer-and-reader-nodes">Check cached pages on both writer and reader nodes</h4>
<ul>
<li>
<p><strong>Pg_buffercache</strong> extension provides a means to look into the contents of the buffer cache. We will be leveraging the pg_buffercache view to examine the content of the buffer cache (with the CCM enabled and CCM disabled) to illustrate the effect of the CCM. We will compare the content of the buffer cache of the Writer node with the Reader node.</p>
</li>
<li>
<p>With CCM enabled, the content of the buffer cache of the writer and the reader node will be similar because the writer node will periodically send buffer addresses of the frequently used buffers (defaults to usage count&gt;3) to the reader node to be read from storage.</p>
</li>
</ul>
<ol>
<li>Connect to the Writer node with psql using the cluster endpoint of your cluster</li>
</ol>
<ul>
<li>
<p>Create extension pg_buffercache on the Database.</p>
<pre tabindex="0"><code>psql
CREATE EXTENSION pg_buffercache;
\dx pg_buffercache
</code></pre><p><img alt="benchmark" src="/images/5/5.2/4.png"></p>
</li>
<li>
<p>Verify that you are connected to the Writer node and query pg_buffercache to see number of cached pages for various tables.</p>
<pre tabindex="0"><code>show transaction_read_only;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/5.png"></p>
<pre tabindex="0"><code>SELECT c.relname, count(*) AS buffers
FROM pg_buffercache b 
INNER JOIN pg_class c
ON b.relfilenode = pg_relation_filenode(c.oid) 
AND b.reldatabase IN (0, (SELECT oid FROM pg_database WHERE datname = current_database()))
GROUP BY c.relname
ORDER BY 2 DESC
LIMIT 10;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/6.png"></p>
</li>
</ul>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
        
    	
    	Explain scripts
    	
    	</span>
    </div>
    <div class="expand-content" style="display: none;">
        <table>
<thead>
<tr>
<th>Command</th>
<th>Purposes</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT c.relname, count(*) AS buffers</td>
<td>Queries for the relation name (relname) and the number of buffers used (count(*)), labeling the count as &ldquo;buffers&rdquo;.</td>
</tr>
<tr>
<td>FROM pg_buffercache b</td>
<td>Accesses data from the pg_buffercache system view, which holds details about buffered pages.</td>
</tr>
<tr>
<td>INNER JOIN pg_class c</td>
<td>Combines data from pg_buffercache with information about relations from the pg_class system catalog.</td>
</tr>
<tr>
<td>ON b.relfilenode = pg_relation_filenode(c.oid)</td>
<td>Links entries based on filenodes, associating buffers with their respective relations.</td>
</tr>
<tr>
<td>AND b.reldatabase IN (0, (SELECT oid FROM pg_database WHERE datname = current_database()))</td>
<td>Includes buffers for both shared system catalogs (database 0) and the current database.</td>
</tr>
<tr>
<td>GROUP BY c.relname</td>
<td>Aggregates results based on relation names.</td>
</tr>
<tr>
<td>ORDER BY 2 DESC</td>
<td>Sorts in descending order based on the number of buffers (count(*) in position 2)</td>
</tr>
<tr>
<td>LIMIT 10;</td>
<td>Restricts output to the top 10 relations.</td>
</tr>
</tbody>
</table>

    </div>
</div>
<h4 id="connect-to-the-read-replica">Connect to the Read replica</h4>
<ol>
<li>
<p>Open the Amazon RDS <a href="https://console.aws.amazon.com/rds/home?#database:">console</a> .</p>
</li>
<li>
<p>In the navigation pane, choose Databases and click on the name of the Aurora cluster you created.</p>
</li>
<li>
<p>Under <strong>Connectivity and Security</strong> tab, copy the <strong>Endpoint of type Reader</strong>.</p>
</li>
<li>
<p>Replace <!-- raw HTML omitted --> below with the Aurora reader endpoint you copied above and using psql command line check if pg_buffercache extension is installed.</p>
</li>
</ol>
<pre tabindex="0"><code>psql -h &lt;Aurora Reader EndPoint&gt;
\dx pg_buffercache
</code></pre><p><img alt="benchmark" src="/images/5/5.2/7.png"></p>
<ul>
<li>
<p>Verify if you are connected to the Reader node and query pg_buffercache to see number of cached pages for various tables.</p>
<pre tabindex="0"><code>show transaction_read_only;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/8.png"></p>
<pre tabindex="0"><code>SELECT c.relname, count(*) AS buffers
  FROM pg_buffercache b INNER JOIN pg_class c
  ON b.relfilenode = pg_relation_filenode(c.oid) AND
  b.reldatabase IN (0, (SELECT oid FROM pg_database
  WHERE datname = current_database()))
  GROUP BY c.relname
  ORDER BY 2 DESC
  LIMIT 10;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/9.png"></p>
</li>
</ul>
<p><em>Notice that, after disabling CCM the buffer page count on the reader node is much less compared to the writer node for the frequently accessed tables.</em></p>
<h4 id="failover-aurora-cluster">Failover Aurora cluster</h4>
<ul>
<li>
<p>Now, we will initiate a failover of the Aurora cluster and after the failover is complete, we’ll run the same benchmark on the new writer node. For initiating failover go to the RDS console, select the writer instance of your Aurora cluster and click <strong>Failover</strong> in the <strong>Actions</strong> menu.
<img alt="benchmark" src="/images/5/5.2/10.png"></p>
</li>
<li>
<p>Click <strong>Failover</strong> to confirm.
<img alt="benchmark" src="/images/5/5.2/11.png"></p>
</li>
<li>
<p>Once the failover is complete (after about ~30 seconds), verify that the previous reader node becomes the new writer.
<img alt="benchmark" src="/images/5/5.2/12.png">
<img alt="benchmark" src="/images/5/5.2/13.png"></p>
</li>
</ul>
<h4 id="run-benchmark-using-pgbench-on-new-writer-node-after-failover">Run benchmark using pgbench on new writer node (after failover)</h4>
<ul>
<li>Now we’ll run the same pgbench benchmark as we did earlier and we will compare the metrics observed before and after the failover.</li>
</ul>
<pre tabindex="0"><code>pgbench --progress-timestamp -M prepared -n -T 600 -P 5  -c 50 -j 50 -b tpcb-like@1 -b select-only@20 &gt; ccm_enable_after_failover.out
</code></pre><ul>
<li>After 600 seconds when benchmark is complete, you can verify the pgbench output on the screen or refer the output file “ccm_enable_after_failover.out”. The summary output will look like below. Please note that your output may look a little different.</li>
</ul>
<pre tabindex="0"><code>cat ccm_enable_after_failover.out
</code></pre><p><img alt="benchmark" src="/images/5/5.2/14.png"></p>
<p><em>Notice that after disabling CCM, the tps numbers on the new writer node after failover is significantly less compared to the old writer node before the failover.</em></p>
<h3 id="benchmarking-with-ccm-disabled">Benchmarking with CCM disabled</h3>
<p>Now, we will disable CCM and perform similar tests as we did above with CCM enabled.</p>
<h4 id="disable-ccm">Disable CCM</h4>
<p>Disable CCM on the Aurora PostgreSQL cluster by modifying the cluster parameter group and setting the value of <strong>apg_ccm_enabled</strong> parameter to 0.</p>
<ol>
<li>
<p>Open the Amazon RDS console and select <a href="https://console.aws.amazon.com/rds/home?#parameter-groups:id=">Parameters groups</a> .</p>
</li>
<li>
<p>In the list, choose the parameter group for your Aurora PostgreSQL DB cluster. ]
<img alt="benchmark" src="/images/5/5.2/14.png"></p>
</li>
<li>
<p>Click on the DB cluster parameter group selected above and then click on <strong>Edit Parameters</strong>.
<img alt="benchmark" src="/images/5/5.2/15.png"></p>
</li>
<li>
<p>Set the value of the <code>apg_ccm_enabled</code> cluster parameter to 0 and click on <strong>Save changes</strong>.
<img alt="benchmark" src="/images/5/5.2/16.png"></p>
</li>
<li>
<p>Verify Cluster Cache Management is disabled by querying the function aurora_ccm_status() as shown below:</p>
</li>
</ol>
<pre tabindex="0"><code>psql
\x
select * from aurora_ccm_status();
</code></pre><p><img alt="benchmark" src="/images/5/5.2/17.png"></p>
<h4 id="clear-buffer-cache-of-both-writer-and-reader-nodes">Clear buffer cache of both writer and reader nodes</h4>
<p>Since earlier testing with CCM already warmed the buffer cache of the reader and writer instances, we need to stop and start the Aurora cluster to empty the buffer caches before running the next benchmarking. We could also reboot both the reader and the writer instances, but this may not guarantee that the writer and reader will come up with empty buffer cache.</p>
<h5 id="to-stop-the-cluster">To stop the cluster</h5>
<ol>
<li>
<p>Verify that the cluster status is shown as “Available”, then click on the <strong>Actions</strong> menu and choose <strong>Stop temporarily</strong>.
<img alt="benchmark" src="/images/5/5.2/18.png"></p>
</li>
<li>
<p>Confirm the action by clicking <strong>Stop temporarily</strong> database.
<img alt="benchmark" src="/images/5/5.2/19.png"></p>
</li>
</ol>
<p><em>It will take several minutes and the cluster status will change from Stopping to Stopped.</em>
<img alt="benchmark" src="/images/5/5.2/20.png"></p>
<h5 id="to-start-the-cluster">To start the cluster</h5>
<ol>
<li>Once the cluster status changes to ”Stopped”, click on the <strong>Actions</strong> menu again and choose <strong>Start</strong>.
<img alt="benchmark" src="/images/5/5.2/21.png"></li>
</ol>
<p><em>It will take several minutes and the cluster status will change from &ldquo;Starting&rdquo; to &ldquo;Available&rdquo;.</em></p>
<h4 id="run-benchmark-on-writer-node-using-pgbench-before-failover">Run benchmark on writer node using pgbench (before failover)</h4>
<ol>
<li>Run benchmark using pgbench  on the Aurora cluster writer node like earlier.</li>
</ol>
<pre tabindex="0"><code>pgbench --progress-timestamp -M prepared -n -T 600 -P 5 -c 50 -j 50 -b tpcb-like@1 -b select-only@20 &gt; ccm_disable_before_failover.out
</code></pre><ol start="2">
<li>After 600 seconds when benchmark is complete, you can verify the pgbench output on the screen or refer the output file “ccm_disable_before_failover.out”. The summary output will look like below. Please note that your output may look a little different.</li>
</ol>
<pre tabindex="0"><code>cat ccm_disable_before_failover.out
</code></pre><p><img alt="benchmark" src="/images/5/5.2/22.png"></p>
<h4 id="check-cached-pages-on-both-writer-and-reader-nodes-1">Check cached pages on both writer and reader nodes</h4>
<ol>
<li>Connect to the Writer node using the cluster endpoint of your cluster</li>
</ol>
<pre tabindex="0"><code>psql
\dx pg_buffercache
</code></pre><p><img alt="benchmark" src="/images/5/5.2/23.png"></p>
<ol start="2">
<li>Verify that you are connected to the Writer node and query <strong>pg_buffercache</strong> to see number of cached pages for various tables.</li>
</ol>
<pre tabindex="0"><code>show transaction_read_only;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/24.png"></p>
<pre tabindex="0"><code>SELECT c.relname, count(*) AS buffers
 FROM pg_buffercache b INNER JOIN pg_class c
 ON b.relfilenode = pg_relation_filenode(c.oid) AND
 b.reldatabase IN (0, (SELECT oid FROM pg_database
 WHERE datname = current_database()))
 GROUP BY c.relname
 ORDER BY 2 DESC
 LIMIT 10;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/25.png"></p>
<h4 id="connect-to-the-read-replica-1">Connect to the read replica</h4>
<ol>
<li>Connect to the reader instance using the Reader Endpoint of the Aurora PostgreSQL Cluster. Replace <!-- raw HTML omitted --> below with your Aurora reader endpoint by referring the step Connect to the Read replica.</li>
</ol>
<pre tabindex="0"><code>psql -h  &lt;Aurora Reader EndPoint&gt;
\dx pg_buffercache
</code></pre><p><img alt="benchmark" src="/images/5/5.2/26.png"></p>
<ol start="2">
<li>Verify that you are connected to the Reader node and query <strong>pg_buffercache</strong> to see number of cached pages for various tables.</li>
</ol>
<pre tabindex="0"><code>show transaction_read_only;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/27.png"></p>
<pre tabindex="0"><code>SELECT c.relname, count(*) AS buffers
 FROM pg_buffercache b INNER JOIN pg_class c
 ON b.relfilenode = pg_relation_filenode(c.oid) AND
 b.reldatabase IN (0, (SELECT oid FROM pg_database
 WHERE datname = current_database()))
 GROUP BY c.relname
 ORDER BY 2 DESC
 LIMIT 10;
</code></pre><p><img alt="benchmark" src="/images/5/5.2/28.png"></p>
<p><em>Notice that, after disabling CCM the buffer page count on the reader node is much less compared to the writer node for the frequently accessed tables.</em></p>
<h4 id="failover-aurora-cluster-1">Failover Aurora cluster</h4>
<ol>
<li>Now, we will initiate a failover of the Aurora cluster and after the failover is complete, we’ll run the same benchmark on the new writer node.</li>
</ol>
<p><img alt="benchmark" src="/images/5/5.2/29.png"></p>
<ol start="2">
<li>Confirm the action by clicking <strong>Failover</strong>.</li>
</ol>
<p><em>Once the failover is complete (after about ~30 seconds), verify that the previous reader node becomes the new writer.</em></p>
<p><img alt="benchmark" src="/images/5/5.2/30.png"></p>
<h4 id="run-benchmark-using-pgbench-on-new-writer-node-after-failover-1">Run benchmark using pgbench on new writer node (after failover)</h4>
<ol>
<li>Now, we’ll run the same benchmarking as we did earlier and we will compare the pgbench metrics observed before and after the failover.</li>
</ol>
<pre tabindex="0"><code>pgbench --progress-timestamp -M prepared -n -T 600 -P 5 -c 50 -j 50 -b tpcb-like@1 -b select-only@20 &gt; ccm_disable_after_failover.out
</code></pre><p>After 600 seconds when benchmark is complete, you can verify the pgbench output on the screen or refer the output file “ccm_disable_after_failover.out”. The summary output will look like below. Please note that your output may look a little different.</p>
<pre tabindex="0"><code>cat ccm_disable_after_failover.out
</code></pre><p><img alt="benchmark" src="/images/5/5.2/31.png"></p>
<p><em>Notice that after disabling CCM, the tps numbers on the new writer node after failover is significantly less compared to the old writer node before the failover.</em></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/5-clustercachemanagement/5-1-setupclustercachemanagement/" title="Setup cluster cache management"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/6-databaseactivitystreaming/" title="Database activity streaming" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1711431242"></script>
    <script src="/js/perfect-scrollbar.min.js?1711431242"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1711431242"></script>
    <script src="/js/jquery.sticky.js?1711431242"></script>
    <script src="/js/featherlight.min.js?1711431242"></script>
    <script src="/js/highlight.pack.js?1711431242"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1711431242"></script>
    <script src="/js/learn.js?1711431242"></script>
    <script src="/js/hugo-learn.js?1711431242"></script>

    <link href="/mermaid/mermaid.css?1711431242" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1711431242"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
